<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="sf-life" attributes="">
    <template>
        <link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
        <link rel="import" href="../bower_components/core-drawer-panel/core-drawer-panel.html">
        <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.min.css">
        <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="../js/vanilla.js"></script>
        <style>
        .left-panel {
            background-color: #45DFBE;
            height: 100%;
            padding: 50px;
        }
        .right-panel {
            background-color: #FFFFFF;
            height: 100%;
        }
        .option-tab {
        }
    </style>
    <div class="top-section">
    <div class="row">
      <div class="col-md-4 left-panel">
        <div center horizontal layout>
            <div flex><h2>EDGE</h2></div>
        </div>
        </br>
        <template repeat="{{ feature in features }}">
            <div center horizontal layout class="option-tab">
                <div flex> {{feature[0]}} </div>
                <paper-toggle-button id="{{feature[0]}}" role="button" aria-checked="false" on-core-change="{{featureToggled}}"></paper-toggle-button>
            </div> 
        </template>
      </div>
      <div class="col-md-8 right-panel">
          <div id="map" style="width: 100%; height: 100%"></div>
      </div>

    </div>
    </div>
    </template>
    <script src="../js/d3.v2.min.js"></script>
    <script src="../bower_components/require/build/require.min.js"></script>
    <script src="../bower_components/underscore/underscore-min.js" type="text/javascript"></script>
    <script>
        Polymer('sf-life', {
            metricData: null,
            features: [],
            scores: {},
            total: 0,
            ready: function() {
                var r = new XMLHttpRequest();
                var that = this;
                r.open("GET", "static/data/SF.json", true);
                r.onreadystatechange = function () {
                  if (r.readyState != 4 || r.status != 200) return;
                  metricData = JSON.parse(r.responseText);
                  console.dir(metricData.format);
                  _.each(metricData.format, function(feature){
                    that.features.push([feature, false]);
                  })
                  console.dir(metricData.data)
                  _.map(metricData.data, function(num, key){
                    that.scores[key] = num;
                  });
                  console.dir(that.scores);
                };
                r.send("na");
                var arr = [];
                var rates = [];
                var width = this.$.map.offsetWidth;
                var height = this.$.map.offsetHeight;
                var map = d3.select(this.$.map).append('svg').attr("width", width)
                .attr("height", height);
                var path = d3.geo.path().projection(d3.geo.albers().origin([-122.4031949051393, 37.80511854740679]).scale(400000).translate([700, 223]));
                d3.json('static/data/AsthmaRates_CB00.json', function(json) {
                    map.selectAll('path')
                           .data(json.features)
                           .enter().append('path')
                           .attr('d', path)
                           .attr("id", function(d, i){ /*console.log(i);*/ return 'n' + i })
                           .attr('class', function(d, i) {
                               //console.log('block: ' + d.properties.BLOCKGROUP);
                               //   console.log('zip z' + d.properties);
                               arr.push(d.properties);
                               return 'block b' + d.properties.BLOCKGROUP // + 'num id' + i
                           })
                           .style("fill", function(d, i){ /*console.log(i);*/ return 'n' + i })
                           .on('mouseover', function() {
                                var zip = d3.select(this).attr('class').split('block b').join('');
                                var ques = d3.select(this).attr('id').split('n').join('');
                                var score = that.calculateScore(zip);
                                console.log('block ' + zip + ' selected with id ' + ques + ' with score ' + score + ' and total ' + that.total);

                                d3.select(that.$.map).selectAll('p').text('');
                                for (key in arr) {
                                    d3.select(that.$.map.querySelector('.b' + arr[key].BLOCKGROUP)).style("fill", "black");
                                }
                                d3.select(that.$.map.querySelector('.b' + zip)).style("fill", "purple");
                                //d3.select(this.$.map).append('p').text('District: ' + zip);
                                //d3.select(this.$.map).append('p').text('Value: ' + arr[ques].ASTHMARATE);
                                //Sample -- d3.select('#map .z94110').style("fill", "purple");
                                //highlightZip(zip);
                           });
                }); 

            },
            calculateScore: function(district_id) {
                console.log("calculating score");
                score = 0.0;
                feature_scores = this.scores[district_id];
                console.dir(feature_scores);
                for (var i = 0; i < feature_scores.length; i++) {
                    if (this.features[i][1]) {
                        score += feature_scores[i];
                    }
                }
                if (this.total > 0){
                    score = score/this.total;
                } else {
                    score = 0.0;
                }
                return score;
            },
            updateTotal: function() {
                console.log("updating total");
                sum = 0;
                _.each(this.features, function(feature){
                    console.log(feature);
                    if (feature[1] == true){
                        sum++;
                    }
                })
                this.total = sum;
                this.calculateScore("060750167002");
            },
            featuresChanged: function(oldValue) {
                this.updateTotal();
            },
            featureToggled: function(obj) {
                var index = -1;
                _.each(this.features, function(feature){
                    if (feature[0] == obj.target.id){
                        feature[1] = !feature[1];
                    }
                })
                this.updateTotal();
            }
        });
    </script>
    
</polymer-element>